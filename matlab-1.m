% reset the workspace
clear
close all

% load spiral drawing data
d = read_trc("lue-spiral.trc");

% set plotting parameters
TL = [0 5];
nr = 2;
nc = 3;

% plot the left hand marker in x-y-z
marker_name = "L.Finger3.M3";
marker_xyz = d{:,find(names(d) == "L.Finger3.M3") + [0:2]}

t = d{:,"Time"};
t_inds = t>min(TL)&t<max(TL);
t_secs = rem(t(t_inds),1)==0;


% plot
figure
% subplot(nr,nc,1)
hold on
subplot(1 ,1 ,1)
plot(marker_xyz(:,1), t_inds)
plot(marker_xyz(:,2), t_inds)
plot(marker_xyz(:,3), t_inds)
%%% YOUR CODE HERE

% Filter out large, slow movements with a high-pass butterworth filter at 2
% Hz cutoff and filter out jitter with a low-pass butterworth filter at 20
% Hz cutoff. A 6th order filter is fine.

% sampling freq fs is the reciprocal of the difference between two points
% fs = 1/mean(diff(t));
% 
% % cutoff frequencies for the filter
% fc_hi = 2;
% fc_lo = 20;
% 
% % [b,a] = butter(n,Wn) returns the transfer function coefficients of an 
% % nth-order lowpass digital Butterworth filter with normalized 
% % cutoff frequency Wn [https://www.mathworks.com/help/signal/ref/butter.html]
% 
% %%% YOUR CODE HERE
% [b_l, a_l] = butter(6, [fc_hi fc_lo])
% 
% 
% % calculate the first PC
% 
% %%% YOUR CODE HERE
% 
% % calculate projection onto first PC
% 
% %%% YOUR CODE HERE
% 
% % smooth with a savitsky-golay smoother
% proj_smooth = smoothdata(proj,'sgolay');
% 
% % count zero crossings
% zcd = dsp.ZeroCrossingDetector();
% numZeroCross = cast(zcd(proj_smooth(t_inds)),"double");
% tremorFrequency = (numZeroCross/2)/max(TL);
% 
% % get envelope from 25 sample moving average
% env_width = 25;
% env = movmax(proj_smooth(t_inds),env_width);
% 
% % use the median of the moving maximum as the estimator of the amplitude
% amp = median(env);
% 
% ttl = round(tremorFrequency,1) + " Hz, " + round(2*amp,1) + " mm amplitude";
% 
% % plot
% subplot(nr,nc,[5 6])
% hold on
% plot(t,proj,'k.')
% plot(t,proj_smooth,'r')
% h1 = refline(0,amp);
% h2 = refline(0,-amp);
% h1.Color = 0.5*[1 1 1];
% h2.Color = 0.5*[1 1 1];
% xlim(TL)
% title(ttl)
% ylabel("mm")
% xlabel("seconds")
